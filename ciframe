#!/bin/bash
#
#	Un meta cifrador, descrifrador y estenografia
#
#	version 0.1 alfa
#
# --------------------------- funciones ---------------------------------

function opciones {

	while getopts t:m: OPCION
	do
	        case $OPCION in
	                t) TITULO=${OPTARG}
	                ;;
	                m) MENSAJE=${OPTARG}
	                ;;
	        esac
	done
	# parametros
	N=0
	for T in $(cat /dev/stdin); do
		T=$(echo $T | sed 's/_/\ /g')
		C="$C $N \"$T\""
		N=$(($N+1))
	done
	# genera el menu
	eval "zenity --title \"$TITULO\" --text \"$MENSAJE\" --list --column \"\" --column \"\" --hide-column 1  --hide-header $C"

}
function error {
	zenity --error
}
function clave {
	zenity --title "Clave" --text "Introduce la clave" --entry
}
function url {
	zenity --title "URL" --text "Introducir dirección" --entry
}
function archivo {
	zenity --title "elije el archivo" --file-selection
}
function archivos {
	echo -e "$(zenity --title "Archivos" --title "Elije el archivos" --file-selection --multiple --separator="\n")"
}
function mensaje {
	zenity --title "Mensaje" --text="introduce el mensaje" --text-info --editable
}
function mostrar {
	cat /dev/stdin | zenity --title "Mensaje" --text="¡Listo!" --text-info
}
function papelera {
	cat /dev/stdin | xsel
}
function progreso {
	zenity  --progress --pulsate  --auto-close  --auto-kill
}

# -------------------------- programa ----------------------------------


# ¿Que queres hacer?
MENU=`echo  "Cifrar Descrifrar Quitar_metadatos Eliminar_archivos" | opciones -t "Ciframatic" -m "¿Que queres hacer?"`

case $MENU in
	0 )
	# Cifrar
	#------------------ entrada ----------------------
	MENU=`echo -e "Mensaje Archivo" | opciones -t "Ciframe" -m "¿Que deseas proteger?"` || exit
	case $MENU in
		0 )
			ef=`mensaje`
		;;
		1 )
			ef=`cat $(archivo || exit)`
		;;
	esac
	k=`pwgen  -1 -s |clave`
	MENU=`echo -e "Mensaje Archivo Imagen_al_azar tinyURL Publicar" | opciones -t "¿En donde?" -m "¿Donde lo queres ocultar?"` || exit
	case $MENU in
	0 )
		# genera el mensaje y lo muestra en base64
		m=` echo "$ef" | mcrypt -z -u -k "$k" -F | base64 -w0 `
		echo "$m" | papelera
		echo "$m" | mostrar
		;;
	1 )
		# guardar en un archivo (propio)
		b=`archivo || exit`
		echo "$ef" | steghide embed -ef - -p "$k" -cf "$b"
		;;
	2 )
		# busca una imagen al azar en la web (con tor)
		# http://thepaperwall.com/rss.recentfifty.php
		# 
		p=`clave`
		echo "$ef" | steghide embed -ef - -p "$k" -cf "$b"
		;;
	3 )
		# publicar en tinyURL con Tor
		# genera el mensaje y lo muestra en base64
		m=`echo "$ef" | mcrypt -z -u -k "$k" -F | base64 -w0`
		u=`wget -U Mozilla "https://tinyurl.com/create.php?url=data:text/html;charset=utf-8;base64,$m" -qO - \
		| grep "https://tinyurl.com/"` | progreso
		echo "$u" > /dev/stderr
		echo "$u" | papelera
		echo "$u" | mostrar
		# no se por que no genera la tinyurl a veces
		;;
	3 )
		# publicar en Uploader con Tor
		# genera el mensaje y lo muestra en base64
		m=`echo "$ef" | mcrypt -z -u -k "$k" -F | base64 -w0`
		# http://uploadpie.com/
		u=`wget -U Mozilla "https://tinyurl.com/create.php?url=data:text/html;charset=utf-8;base64,$m" -qO - \
		| grep "https://tinyurl.com/"` | progreso
		echo "$u" > /dev/stderr
		echo "$u" | papelera
		echo "$u" | mostrar
		# no se por que no genera la tinyurl a veces
		;;
	esac
	;;
	1 )
	# Descifrar

	# mensaje archivo o URL
	MENU=`echo -e "Mensaje Archivo Dirección_de_internet" | opciones -t "Descifrar" -m "¿Donde queres buscar?"` || exit
	case $MENU in
		0 )
			# descifrado
			t=`mensaje` || exit
			k=`clave`
			m=`$t | sed 's/\ [^1-9A-Za-z]=//g'| base64 -d | mdecrypt - -z -k "$k" -F` || error && exit

			# lo guarda en la papelera y lo muestra
			echo "$m" | papelera
			echo "$m" | mostrar
		;;
		1 )
			# archivo
			sf=`archivo` || exit
			# mensaje descifrado en archivo
			p=`clave`
			steghide extract -p "$p" -sf "$sf" -xf - | mostrar
		;;
		2 )
			# url
			URL=`url` || exit
			# mensaje descifrado en archivo
			p=`clave`
			sf=`mktemp`
			# visitar la pagina de internet con Tor
			proxychains wget "$URL" -O $sf | progreso
			m=`steghide extract -p "$p" -sf $sf -xf -`
			# borrar el archivo temporal para siempre
			shred -uz -n 10	$sf
			echo "$m" | mostrar
		;;
	esac

	;;
	2 )
		# Quitar metadatos
		archivos  || exit | while read ARCHIVO; do
			# falta quitar las caras
			# opcion para romper pixels
			convert -strip "$ARCHIVO" "$ARCHIVO"
		done | progreso
	;;
	3 )
		# Eliminar archivos de modo seguro
		archivos || exit | while read ARCHIVO; do
			# borra el archivo para simpre
			shred -uz -n 10	"$(archivo)" | progreso
		done | progreso
	;;
esac

exit

# Como funciona

- ¿Que queres hacer?

  1a. buscar mensaje
     1a. ¿campo de entrada para el mensaje?
     1b. ¿desde un archivo?
       a. buscar archivo
     1b. ¿desde una URL?
       a. Feed (busca descifra y se queda a la espera) con Tor
       b. Archivo lo descarga con Tor descifra y borra (de modo seguro)
     2. poner password
     3. mensaje descifrado

  1b. ¿Que queres ocultar?
     1a. Mensaje
       a. campo de entrada para el mensaje de texto
     1b. Archivo
       b. campo para elegir el archivo
     2. generar archivo con mensaje oculto
       1a. ¿elige un archivo?
         b. campo para elegir el archivo
       1b. ¿descarga una imagen o audio al azar?
       2. la modifica sustancialmente
       3. agrega el mensaje al archivo
     3a. Publicación
       4. publica de modo anonimo usando Tor
     3b. Guardar (sobre escribe el archivo)
