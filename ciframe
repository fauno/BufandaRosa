#!/bin/bash
#
#	Un meta cifrador, descrifrador y estenografia
#
#

# funciones

function opciones {
	# parametros
	# -t "Eleccion" -m "que elegis" -c '"A" "B" "C"'
	menu=`zenity --title "$titulo" --text "$mensaje" --list --column "" --column "" --hide-header $columna` || exit
}
function clave {
	zenity --title "Clave" --text "Introduce la clave" --entry
}
function url {
	zenity --title "URL" --text "Introducir dirección" --entry "http://"
}
function archivo {
	zenity --title "elije el archivo" --file-selection
}
function archivos {
	echo -e "$(zenity --title "elije el archivo" --file-selection --multiple --separator="\n")"
}
function mensaje {
	zenity --title "Mensaje" --text="introduce el mensaje" --text-info --editable
}
function mostrar {
	cat /dev/stdin | zenity --text="¡Listo!" --text-info
}
function papelera {
	cat /dev/stdin | xsel
}
function progreso {
	zenity  --progress --pulsate  --auto-close  --auto-kill
}

# programa

# ¿Que queres hacer?
MENU=`zenity --title "Ciframatic" --text "¿Que queres hacer?" --list --column "" --column "" --hide-column 1 --hide-header \
0 "Cifrar" 1 "Descrifrar" 2 "Quitar metadatos" 3 "Eliminar archivos" `

case $MENU in
	0 )
	# Cifrar
	MENU=`zenity --title "Ciframe" --text "¿Que deseas proteger?" --list \
	--column "" --hide-header "Mensaje" "Archivo"` || exit
	case $MENU in
		"Mensaje" )
			ef=`mensaje`
		;;
		"Archivo" )
			ef=`cat $(archivo || exit)`
		;;
	esac
	echo $ef > /dev/stderr

	k=`clave`

	MENU=`zenity --title "En donde" --text "¿Donde lo queres ocultar?" --list \
	--column "" --hide-header "Mensaje" "Archivo"`|| exit

	case $MENU in
	"Mensaje" )
		# genera el mensaje y lo muestra en base64
		m=` echo "$ef" | mcrypt -z -u -k "$k" -F | base64 -w0 `
		echo "$m" | papelera
		echo "$m" | mostrar
		exit
		;;
	"Archivo" )
		MENU=`zenity --title "Ocultar" --text "Donde lo queres ocultar" --list \
		--column "" --hide-header "Elegir" "Azar"`|| exit
		case $MENU in
			"Elegir" )
				b=`archivo || exit`
				echo "$ef" | steghide embed -ef - -p "$k" -cf "$b"
				;;
			"Azar" )
				# busca una imagen al azar en la web (con tor)
				p=`clave`
				echo "$ef" | steghide embed -ef - -p "$k" -cf "$b"
				;;
			esac
		;;
	esac
	;;
1 )
	# Descrifrar

	# mensaje archivo o URL
	MENU=`zenity --title "Ciframatic" --text "Donde queres buscar el mensaje" --list \
	--column "" --column "" --hide-column 1 --hide-header 0 "Mensaje" 1 "Archivo" 2 "Dirección de internet"`|| exit
	case $MENU in
	0 )
		# descifrado
		k=`clave`
		m=`mensaje | sed 's/\ [^1-9A-Za-z]=//g'| base64 -d | mdecrypt - -z -k "$k" -F` || exit
		# lo guarda en la papelera y lo muestra
		echo "$m" | papelera
		echo "$m" | mostrar
		;;
	1 )
		# archivo
		sf=`archivo || exit`
		# mensaje descifrado en archivo
		p=`clave`
		steghide extract -p "$p" -sf "$sf" -xf - | mostrar
		;;
	2 )
		# archivo
		URL=`url || exit`
		# mensaje descifrado en archivo
		p=`clave`
		sf=`mktemp`
		proxychains wget "$URL" -O $sf | progreso
		m=`steghide extract -p "$p" -sf $sf -xf -`
		shred -uz -n 10	$sf
		echo "$m" | mostrar
		;;
	esac

	;;
	2 )
		# Quitar metadatos
		archivos  || exit | while read ARCHIVO; do
			echo $ARCHIVO > /dev/stderr
			convert -strip "$ARCHIVO" "$ARCHIVO"
			# falta quitar las caras
		done | progreso
	;;
	3 )
		# Eliminar archivos de modo seguro
		archivos || exit | while read ARCHIVO; do
			echo $ARCHIVO > /dev/stderr
			shred -uz -n 10	"$(archivo)" | progreso
		done | progreso
	;;
esac

exit

# Como funciona

- ¿Que queres hacer?

  1a. buscar mensaje
     1a. ¿campo de entrada para el mensaje?
     1b. ¿desde un archivo?
       a. buscar archivo
     1b. ¿desde una URL?
       a. Feed (busca descifra y se queda a la espera) con Tor
       b. Archivo lo descarga con Tor descifra y borra (de modo seguro)
     2. poner password
     3. mensaje descifrado

  1b. ¿Que queres ocultar?
     1a. Mensaje
       a. campo de entrada para el mensaje de texto
     1b. Archivo
       b. campo para elegir el archivo
     2. generar archivo con mensaje oculto
       1a. ¿elige un archivo?
         b. campo para elegir el archivo
       1b. ¿descarga una imagen o audio al azar?
       2. la modifica sustancialmente
       3. agrega el mensaje al archivo
     3a. Publicación
       4. publica de modo anonimo usando Tor
     3b. Guardar (sobre escribe el archivo)
